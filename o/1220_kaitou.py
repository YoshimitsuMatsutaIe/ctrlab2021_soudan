import numpy as np
from math import sin, cos, sqrt
import matplotlib.pyplot as plt
import sympy as sy
import scipy as sp
import scipy.optimize
from scipy.optimize import fsolve
from scipy.integrate import odeint


c1 = 837019575
c2 = 4133430
c3 = 32805
c4 = 486
c5 = 18
c6 = 55801305
c7 = 688905
c8 = 3645
c9 = 81

r = 0.0125
L0 = 0.15


def calc_X(L, xi):
    """アクチュエータ空間からタスク空間への写像
    
    L = [L[0,0], L[1,0], L[2,0]] -> X = [x, y, z]
    """
    
    
    A1 = L[0,0]**2 + L[1,0]**2 + L[1,0]**2 - \
        L[0,0]*L[1,0] - L[0,0]*L[2,0] - L[1,0]*L[2,0]
    A2 = 2*L[0,0] - L[1,0] - L[2,0]
    A3 = L[1,0] - L[2,0]
    A4 = 3*L0 + L[0,0] + L[1,0] + L[2,0]
    
    x = -(A2 * A1**4 * A4 * xi**10) / ((c1 * r**9)) + \
        (A2 * A1**3 * A4 * xi**8) / (c2 * r**7) - \
            (A2 * A1**2 * A4 * xi**6) / (c3 * r**5) + \
                (A2 * A1 * A4 * xi**4) / (c4 * r**3) - \
                    (A2 * A4 * xi**2) / (c5 * r)
    
    y = -(sqrt(3) * A4 * A3 * A1**4 * xi**10) / (c1 * r**9) + \
        (sqrt(3) * A4 * A3 * A1**3 * xi**8) / (c2 * r**7) - \
            (sqrt(3) * A4 * A3 * A1**2 * xi**6) / (c3 * r**5) + \
                (sqrt(3) * A4 * A1 * A2 * xi**4) / (c4 * r**3) - \
                    (sqrt(3) * A4 * A3 * xi**2) / (c5 * r)
    
    z = (2 * A1**4 * A4 * xi**9) / (c6 * r**8) - \
        (4 * A1**3 * A4 * xi**7) / (c7 * r**6) + \
            (2 * A1**2 * A4 * xi**5) / (c8 * r**4) - \
                (2 * A1 *A4 * xi**3) / (c9 * r**2) + \
                    (A4 * xi) / 3

    return np.array([[x, y, z]]).T


def Jacobian(L, xi):
    """ヤコビ行列"""
    
    l1 = L[0,0]
    l2 = L[1,0]
    l3 = L[2,0]
    return np.array([
        [
            -xi**2*(2*l1 - l2 - l3)/(c5*r) - 2*xi**2*(3*L0 + l1 + l2 + l3)/(c5*r) + xi**4*(2*l1 - l2 - l3)**2*(3*L0 + l1 + l2 + l3)/(c4*r**3) + xi**4*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) + 2*xi**4*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - xi**6*(2*l1 - l2 - l3)*(4*l1 - 2*l2 - 2*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c3*r**5) - xi**6*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) - 2*xi**6*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + xi**8*(2*l1 - l2 - l3)*(6*l1 - 3*l2 - 3*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c2*r**7) + xi**8*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) + 2*xi**8*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - xi**10*(2*l1 - l2 - l3)*(8*l1 - 4*l2 - 4*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c1*r**9) - xi**10*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9) - 2*xi**10*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9),
            -xi**2*(2*l1 - l2 - l3)/(c5*r) + xi**2*(3*L0 + l1 + l2 + l3)/(c5*r) + xi**4*(-l1 + 4*l2 - l3)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)/(c4*r**3) + xi**4*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - xi**4*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - xi**6*(-2*l1 + 8*l2 - 2*l3)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c3*r**5) - xi**6*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + xi**6*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + xi**8*(-3*l1 + 12*l2 - 3*l3)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c2*r**7) + xi**8*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - xi**8*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - xi**10*(-4*l1 + 16*l2 - 4*l3)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c1*r**9) - xi**10*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9) + xi**10*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9),
            -xi**2*(2*l1 - l2 - l3)/(c5*r) + xi**2*(3*L0 + l1 + l2 + l3)/(c5*r) + xi**4*(-l1 - l2)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)/(c4*r**3) + xi**4*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - xi**4*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - xi**6*(-2*l1 - 2*l2)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c3*r**5) - xi**6*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + xi**6*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + xi**8*(-3*l1 - 3*l2)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c2*r**7) + xi**8*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - xi**8*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - xi**10*(-4*l1 - 4*l2)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c1*r**9) - xi**10*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9) + xi**10*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9)],
        [
            -sqrt(3)*xi**2*(l2 - l3)/(c5*r) + sqrt(3)*xi**4*(2*l1 - l2 - l3)**2*(3*L0 + l1 + l2 + l3)/(c4*r**3) + sqrt(3)*xi**4*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) + 2*sqrt(3)*xi**4*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - sqrt(3)*xi**6*(l2 - l3)*(4*l1 - 2*l2 - 2*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c3*r**5) - sqrt(3)*xi**6*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + sqrt(3)*xi**8*(l2 - l3)*(6*l1 - 3*l2 - 3*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c2*r**7) + sqrt(3)*xi**8*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - sqrt(3)*xi**10*(l2 - l3)*(8*l1 - 4*l2 - 4*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c1*r**9) - sqrt(3)*xi**10*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9),
            -sqrt(3)*xi**2*(l2 - l3)/(c5*r) - sqrt(3)*xi**2*(3*L0 + l1 + l2 + l3)/(c5*r) + sqrt(3)*xi**4*(-l1 + 4*l2 - l3)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)/(c4*r**3) + sqrt(3)*xi**4*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - sqrt(3)*xi**4*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - sqrt(3)*xi**6*(l2 - l3)*(-2*l1 + 8*l2 - 2*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c3*r**5) - sqrt(3)*xi**6*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) - sqrt(3)*xi**6*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + sqrt(3)*xi**8*(l2 - l3)*(-3*l1 + 12*l2 - 3*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c2*r**7) + sqrt(3)*xi**8*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) + sqrt(3)*xi**8*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - sqrt(3)*xi**10*(l2 - l3)*(-4*l1 + 16*l2 - 4*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c1*r**9) - sqrt(3)*xi**10*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9) - sqrt(3)*xi**10*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9),
            -sqrt(3)*xi**2*(l2 - l3)/(c5*r) + sqrt(3)*xi**2*(3*L0 + l1 + l2 + l3)/(c5*r) + sqrt(3)*xi**4*(-l1 - l2)*(2*l1 - l2 - l3)*(3*L0 + l1 + l2 + l3)/(c4*r**3) + sqrt(3)*xi**4*(2*l1 - l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - sqrt(3)*xi**4*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c4*r**3) - sqrt(3)*xi**6*(-2*l1 - 2*l2)*(l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c3*r**5) - sqrt(3)*xi**6*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + sqrt(3)*xi**6*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c3*r**5) + sqrt(3)*xi**8*(-3*l1 - 3*l2)*(l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c2*r**7) + sqrt(3)*xi**8*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - sqrt(3)*xi**8*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c2*r**7) - sqrt(3)*xi**10*(-4*l1 - 4*l2)*(l2 - l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c1*r**9) - sqrt(3)*xi**10*(l2 - l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9) + sqrt(3)*xi**10*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c1*r**9)],
        [
            xi/3 - xi**3*(4*l1 - 2*l2 - 2*l3)*(3*L0 + l1 + l2 + l3)/(c9*r**2) - xi**3*(2*l1**2 - 2*l1*l2 - 2*l1*l3 + 4*l2**2 - 2*l2*l3)/(c9*r**2) + 2*xi**5*(4*l1 - 2*l2 - 2*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c8*r**4) + 2*xi**5*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c8*r**4) - 4*xi**7*(6*l1 - 3*l2 - 3*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c7*r**6) - 4*xi**7*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c7*r**6) + 2*xi**9*(8*l1 - 4*l2 - 4*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c6*r**8) + 2*xi**9*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c6*r**8),
            xi/3 - xi**3*(-2*l1 + 8*l2 - 2*l3)*(3*L0 + l1 + l2 + l3)/(c9*r**2) - xi**3*(2*l1**2 - 2*l1*l2 - 2*l1*l3 + 4*l2**2 - 2*l2*l3)/(c9*r**2) + 2*xi**5*(-2*l1 + 8*l2 - 2*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c8*r**4) + 2*xi**5*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c8*r**4) - 4*xi**7*(-3*l1 + 12*l2 - 3*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c7*r**6) - 4*xi**7*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c7*r**6) + 2*xi**9*(-4*l1 + 16*l2 - 4*l3)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c6*r**8) + 2*xi**9*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c6*r**8),
            xi/3 - xi**3*(-2*l1 - 2*l2)*(3*L0 + l1 + l2 + l3)/(c9*r**2) - xi**3*(2*l1**2 - 2*l1*l2 - 2*l1*l3 + 4*l2**2 - 2*l2*l3)/(c9*r**2) + 2*xi**5*(-2*l1 - 2*l2)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)/(c8*r**4) + 2*xi**5*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c8*r**4) - 4*xi**7*(-3*l1 - 3*l2)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**2/(c7*r**6) - 4*xi**7*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c7*r**6) + 2*xi**9*(-4*l1 - 4*l2)*(3*L0 + l1 + l2 + l3)*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**3/(c6*r**8) + 2*xi**9*(l1**2 - l1*l2 - l1*l3 + 2*l2**2 - l2*l3)**4/(c6*r**8)
        ]
    ])







def func(L):
    X = calc_X(L.reshape(3,1), xi=1)
    return np.ravel(X)

xd = [0, 0, 0.3]

sol = fsolve(func, xd)


L = np.array([[sol[0],sol[1],sol[2]]]).T
L = np.array([[-0.25,-0.25,0.05]]).T
print(L)
xi_all = np.arange(0, 1, 0.01)

Xs = np.concatenate([calc_X(L, xi).T for xi in xi_all])
print(Xs)

fig = plt.figure()
ax = fig.add_subplot(projection = '3d')
ax.plot(Xs[:, 0], Xs[:, 1], Xs[:, 2], label="arm")

#ax.scatter([xd[0]], [xd[1]], [xd[2]], label="xd")

ax.legend()



# x_max = 0.2
# x_min = -0.2
# y_max = 0.2
# y_min = -0.2
# z_max = 0.2
# z_min = 0
# max_range = max(x_max-x_min, y_max-y_min, z_max-z_min)*0.5
# x_mid = (x_max + x_min) / 2
# y_mid = (y_max + y_min) / 2
# z_mid = (z_max + z_min) / 2

# ax.set_xlim(x_mid-max_range, x_mid+max_range)
# ax.set_ylim(y_mid-max_range, y_mid+max_range)
# ax.set_zlim(z_mid-max_range, z_mid+max_range)

ax.set_box_aspect((1,1,1))

plt.show()